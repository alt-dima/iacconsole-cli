properties([
  parameters([
    [
      $class: 'CascadeChoiceParameter',
      choiceType: 'PT_SINGLE_SELECT',
      name: 'Account',
      description: 'Select the account',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [],
          sandbox: true,
          script: 'return ["ERROR: Failed to fetch accounts"]'
        ],
        script: [
          classpath: [],
          sandbox: true,
          script: '''
            import groovy.json.JsonSlurper

            try {
                def url = new URL('https://api.iacconsole.com/v1/dimension/example-org/account?workspace=master&fallbacktomaster=true&needdimdata=false')
                def connection = url.openConnection()
                connection.setRequestProperty('Authorization', 'Basic NjYyY2FiN2M1ZTExNjgxOTczOGIwMWZlOnN1cGVydG9hc3Rlcg==')
                connection.requestMethod = 'GET'
                
                def response = connection.content.text
                def result = new JsonSlurper().parseText(response)
                
                if (result.Dimensions) {
                    return result.Dimensions.collect { it.DimValue }.unique()
                } else {
                    return ["No accounts found"]
                }
            } catch (Exception e) {
                return ["Error: ${e.message}"]
            }
          '''
        ]
      ]
    ],
    [
      $class: 'CascadeChoiceParameter',
      choiceType: 'PT_SINGLE_SELECT',
      name: 'DataCenter',
      description: 'Select the Data Center',
      script: [
        $class: 'GroovyScript',
        fallbackScript: [
          classpath: [],
          sandbox: true,
          script: 'return ["ERROR: Failed to fetch data centers"]'
        ],
        script: [
          classpath: [],
          sandbox: true,
          script: '''
            import groovy.json.JsonSlurper

            try {
                def url = new URL('https://api.iacconsole.com/v1/dimension/example-org/datacenter?workspace=master&fallbacktomaster=true&needdimdata=false')
                def connection = url.openConnection()
                connection.setRequestProperty('Authorization', 'Basic NjYyY2FiN2M1ZTExNjgxOTczOGIwMWZlOnN1cGVydG9hc3Rlcg==')
                connection.requestMethod = 'GET'
                
                def response = connection.content.text
                def result = new JsonSlurper().parseText(response)
                
                if (result.Dimensions) {
                    return result.Dimensions.collect { it.DimValue }.unique()
                } else {
                    return ["No accounts found"]
                }
            } catch (Exception e) {
                return ["Error: ${e.message}"]
            }
          '''
        ]
      ]
    ]
  ])
])

pipeline {
  agent any
  stages {
    stage('Build') {
      steps {
        git url: 'https://github.com/alt-dima/iacconsole-cli.git', branch: 'main'
        echo "Selected account: ${params.Account}"
        echo "Selected data center: ${params.DataCenter}"
      }
    }
    stage('Install OpenTofu and IacConsole CLI') {
      steps {
        script {
          def arch = sh(script: 'uname -m', returnStdout: true).trim()
          def archSuffix
          if (arch == 'aarch64' || arch == 'arm64') {
            archSuffix = 'arm64'
          } else if (arch == 'x86_64') {
            archSuffix = 'amd64'
          } else {
            error "Unsupported architecture: ${arch}"
          }

          sh "curl -L -o tofu_1.10.7_linux_${archSuffix}.tar.gz https://github.com/opentofu/opentofu/releases/download/v1.10.7/tofu_1.10.7_linux_${archSuffix}.tar.gz"
          sh "tar -xvf tofu_1.10.7_linux_${archSuffix}.tar.gz -C /tmp"
          
          sh "curl -L -o iacconsole-cli_0.6.0_linux_${archSuffix}.tar.gz https://github.com/alt-dima/iacconsole-cli/releases/download/v0.6.0/iacconsole-cli_0.6.0_linux_${archSuffix}.tar.gz"
          sh "tar -xvf iacconsole-cli_0.6.0_linux_${archSuffix}.tar.gz"
        }
      }
    }
    stage('Create .iacconsolerc config') {
      steps {
        writeFile file: '.iacconsolerc', text: '''
defaults:
  units_path: examples/units
  inventory_path: examples/inventory
  cmd_to_exec: /tmp/tofu
'''
      }
    }
    stage('IaCConsole Plan') {
      environment {
        IACCONSOLE_API_URL = 'https://662cab7c5e116819738b01fe:supertoaster@api.iacconsole.com'
      }
      steps {
        ansiColor('xterm') {
          sh "./iacconsole-cli exec -o example-org -d account:${params.Account} -d datacenter:${params.DataCenter} -u demo -- init"
          sh "./iacconsole-cli exec -o example-org -d account:${params.Account} -d datacenter:${params.DataCenter} -u demo -- plan"
        }
      }
    }
    stage('Approval') {
      steps {
        input 'Do you want to apply the changes?'
      }
    }
    stage('IaCConsole Apply') {
      environment {
        IACCONSOLE_API_URL = 'https://662cab7c5e116819738b01fe:supertoaster@api.iacconsole.com'
      }
      steps {
        ansiColor('xterm') {
          sh "./iacconsole-cli exec -o example-org -d account:${params.Account} -d datacenter:${params.DataCenter} -u demo -- apply -auto-approve"
        }
      }
    }
  }
}
